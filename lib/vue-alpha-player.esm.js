import{createElementBlock as e,openBlock as t,createCommentVNode as i,createElementVNode as s,createTextVNode as a,renderSlot as r}from"vue";class o{constructor(e,t){this.container=e,this.video=t,this.canvas=null,this.gl=null,this.program=null,this.texture=null,this.animationId=null,this.isRendering=!1,this.init()}init(){try{this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas),this.gl=this.canvas.getContext("webgl",{alpha:!0,antialias:!1,powerPreference:"high-performance",stencil:!1,depth:!1})||this.canvas.getContext("experimental-webgl"),this.setupShaders(),this.setupGeometry(),this.setupTexture()}catch(e){throw e}}setupShaders(){const e=this.createShader(this.gl.VERTEX_SHADER,"\n\t\t\tattribute vec2 a_position;\n\t\t\tattribute vec2 a_texCoord;\n\t\t\tvarying vec2 v_texCoord;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = vec4(a_position, 0.0, 1.0);\n\t\t\t\tv_texCoord = a_texCoord;\n\t\t\t}\n\t\t"),t=this.createShader(this.gl.FRAGMENT_SHADER,"\n\t\t\t#ifdef GL_ES\n\t\t\tprecision mediump float;\n\t\t\t#endif\n\t\t\t\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_texCoord;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\t// 优化的纹理采样：预计算UV坐标\n\t\t\t\tvec2 leftUv = vec2(v_texCoord.x * 0.5, v_texCoord.y);           // 左半部分（Alpha）\n\t\t\t\tvec2 rightUv = vec2(0.5 + v_texCoord.x * 0.5, v_texCoord.y);   // 右半部分（RGB）\n\t\t\t\t\n\t\t\t\t// 单次采样获取颜色和透明度数据\n\t\t\t\tvec4 colorData = texture2D(u_texture, rightUv);  // RGB数据\n\t\t\t\tfloat alphaData = texture2D(u_texture, leftUv).r; // Alpha数据\n\t\t\t\t\n\t\t\t\tgl_FragColor = vec4(colorData.rgb, alphaData);\n\t\t\t}\n\t\t");this.program=this.createProgram(e,t),this.gl.useProgram(this.program),this.gl.deleteShader(e),this.gl.deleteShader(t)}createShader(e,t){const i=this.gl.createShader(e);if(this.gl.shaderSource(i,t),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)){const e=this.gl.getShaderInfoLog(i);throw this.gl.deleteShader(i),new Error(`着色器编译错误: ${e}`)}return i}createProgram(e,t){const i=this.gl.createProgram();if(this.gl.attachShader(i,e),this.gl.attachShader(i,t),this.gl.linkProgram(i),!this.gl.getProgramParameter(i,this.gl.LINK_STATUS)){const e=this.gl.getProgramInfoLog(i);throw this.gl.deleteProgram(i),new Error(`程序链接错误: ${e}`)}return i}setupGeometry(){const e=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1],t=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(e),this.gl.STATIC_DRAW);const i=this.gl.getAttribLocation(this.program,"a_position");this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,0,0);const s=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,1,1,1,0,0,0,0,1,1,1,0]),this.gl.STATIC_DRAW);const a=this.gl.getAttribLocation(this.program,"a_texCoord");this.gl.enableVertexAttribArray(a),this.gl.vertexAttribPointer(a,2,this.gl.FLOAT,!1,0,0),this.positionBuffer=t,this.texCoordBuffer=s}setupTexture(){this.texture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);const e=this.gl.getUniformLocation(this.program,"u_texture");this.gl.uniform1i(e,0)}render(){if(this.gl&&this.program&&this.video&&!(this.video.readyState<2||0===this.video.videoWidth||0===this.video.videoHeight))try{this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.video),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}catch(e){}}startRenderLoop(){if(this.isRendering)return;this.isRendering=!0;const e=()=>{this.isRendering&&(this.render(),this.animationId=requestAnimationFrame(e))};e()}stopRenderLoop(){this.isRendering=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}resize(e,t){if(!this.canvas)return;const i=Math.min(window.devicePixelRatio||1,2);this.canvas.width=e*i,this.canvas.height=t*i,this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",this.isRendering||this.render()}dispose(){this.stopRenderLoop(),this.gl&&(this.positionBuffer&&this.gl.deleteBuffer(this.positionBuffer),this.texCoordBuffer&&this.gl.deleteBuffer(this.texCoordBuffer),this.texture&&this.gl.deleteTexture(this.texture),this.program&&this.gl.deleteProgram(this.program)),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.gl=null,this.program=null,this.texture=null,this.positionBuffer=null,this.texCoordBuffer=null}}var n={name:"VueAlphaPlayer",props:{src:String,autoplay:{type:Boolean,default:!0},loop:{type:Number,default:0}},data:()=>({isVideoLoaded:!1,isVideoPlaying:!1,isPageVisible:!0,webglPlayer:null,videoPlayCount:1}),computed:{videoLoop(){return 0===this.loop}},methods:{onVideoLoaded(){if(!this.isVideoLoaded){this.isVideoLoaded=!0;try{this.webglPlayer=new o(this.$refs.canvasContainer,this.$refs.videoElement),this.$emit("load");const{width:e,height:t}=this.calculateResponsiveSize();this.webglPlayer.resize(e,t),this.webglPlayer.render(),this.autoplay&&this.playVideo()}catch(e){}}},onVideoPlay(){this.isVideoPlaying=!0,this.webglPlayer&&this.isPageVisible&&this.webglPlayer.startRenderLoop(),this.$emit("play")},onVideoPause(){this.isVideoPlaying=!1,this.webglPlayer&&this.webglPlayer.stopRenderLoop(),this.$emit("pause")},onVideoEnded(){if(this.isVideoPlaying=!1,this.loop>0&&this.videoPlayCount<this.loop)return this.videoPlayCount++,void(this.$refs.videoElement&&this.$refs.videoElement.play());this.videoPlayCount=1,this.webglPlayer&&this.webglPlayer.stopRenderLoop(),this.$emit("ended")},onVideoMetadataLoaded(){this.$refs.videoElement&&!this.isVideoLoaded&&(this.$refs.videoElement.currentTime=.1)},onVideoError(e){},calculateResponsiveSize(){if(!this.$refs.videoElement||!this.$refs.videoShader)return{width:375,height:187.5};const e=this.$refs.videoShader.clientWidth||375,t=this.$refs.videoElement.videoWidth,i=this.$refs.videoElement.videoHeight;if(!t||!i)return{width:e,height:.75*e};const s=e/(t/2/i);return{width:Math.round(e),height:Math.round(s)}},sleep:e=>new Promise(t=>setTimeout(t,e)),async resetPlay(){this.$refs.videoElement&&(this.isVideoPlaying=!1,this.webglPlayer&&this.webglPlayer.stopRenderLoop(),this.videoPlayCount=1,this.$refs.videoElement.currentTime=0,await this.sleep(50),this.$refs.videoElement.pause(),this.webglPlayer&&this.webglPlayer.render(),this.$emit("stop"))},cleanup(){this.webglPlayer&&(this.webglPlayer.dispose(),this.webglPlayer=null),this.$refs.videoElement&&this.$refs.videoElement.pause()},playVideo(){this.$refs.videoElement&&this.$refs.videoElement.play()},pauseVideo(){this.$refs.videoElement&&this.$refs.videoElement.pause()},play(){this.playVideo()},pause(){this.pauseVideo()},reset(){this.resetPlay()},handleVisibilityChange(){this.isPageVisible=!document.hidden,this.webglPlayer&&(this.isPageVisible&&this.isVideoPlaying?this.webglPlayer.startRenderLoop():this.isPageVisible||this.webglPlayer.stopRenderLoop())},handleResize(){if(this.webglPlayer&&this.isVideoLoaded){const{width:e,height:t}=this.calculateResponsiveSize();this.webglPlayer.resize(e,t)}}},mounted(){document.addEventListener("visibilitychange",this.handleVisibilityChange),window.addEventListener("resize",this.handleResize)},beforeDestroy(){document.removeEventListener("visibilitychange",this.handleVisibilityChange),window.removeEventListener("resize",this.handleResize),this.cleanup()}};const l={ref:"videoShader",class:"shader_video_player_webgl"},h=["loop"],d=["src"],g={ref:"canvasContainer",class:"canvas-container"},c={key:0,class:"loading"};!function(e,t){void 0===t&&(t={});var i=t.insertAt;if("undefined"!=typeof document){var s=document.head||document.getElementsByTagName("head")[0],a=document.createElement("style");a.type="text/css","top"===i&&s.firstChild?s.insertBefore(a,s.firstChild):s.appendChild(a),a.styleSheet?a.styleSheet.cssText=e:a.appendChild(document.createTextNode(e))}}(".shader_video_player_webgl .hidden-video[data-v-c051f8a2]{display:none}.shader_video_player_webgl .canvas-container .loading[data-v-c051f8a2]{align-items:center;color:rgba(0,0,0,.6);display:flex;flex-direction:column;justify-content:center}.shader_video_player_webgl .canvas-container .loading .loading-spinner[data-v-c051f8a2]{animation:spin-c051f8a2 1s linear infinite;border:4px solid rgba(0,0,0,.3);border-radius:50%;border-top-color:#000;height:40px;margin-bottom:20px;width:40px}@keyframes spin-c051f8a2{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}"),n.render=function(o,n,u,p,v,m){return t(),e("div",l,[i(" 隐藏的视频元素，用作纹理源 "),s("video",{ref:"videoElement",class:"hidden-video",crossorigin:"anonymous",muted:"",loop:m.videoLoop,preload:"metadata",playsinline:"",onLoadeddata:n[0]||(n[0]=(...e)=>m.onVideoLoaded&&m.onVideoLoaded(...e)),onLoadedmetadata:n[1]||(n[1]=(...e)=>m.onVideoMetadataLoaded&&m.onVideoMetadataLoaded(...e)),onPlay:n[2]||(n[2]=(...e)=>m.onVideoPlay&&m.onVideoPlay(...e)),onPause:n[3]||(n[3]=(...e)=>m.onVideoPause&&m.onVideoPause(...e)),onEnded:n[4]||(n[4]=(...e)=>m.onVideoEnded&&m.onVideoEnded(...e)),onError:n[5]||(n[5]=(...e)=>m.onVideoError&&m.onVideoError(...e))},[s("source",{src:u.src,type:"video/mp4"},null,8,d),n[6]||(n[6]=a(" 您的设备不支持视频播放 ",-1))],40,h),i(" WebGL 渲染容器 "),s("div",g,[i("loading"),v.isVideoLoaded?i("v-if",!0):(t(),e("div",c,[r(o.$slots,"loading",{},()=>[n[7]||(n[7]=s("i",{class:"loading-spinner"},null,-1)),n[8]||(n[8]=s("p",{class:"loading_text"},"动效加载中...",-1))])]))],512)],512)},n.__scopeId="data-v-c051f8a2",n.__file="src/components/vue-alpha-player/vue-alpha-player.vue";n.install=e=>{e.component("VueAlphaPlayer",n)};export{n as default};
